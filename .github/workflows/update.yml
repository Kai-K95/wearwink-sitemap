name: Update sitemap

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: [self-hosted, windows, x64]

    defaults:
      run:
        shell: powershell

    steps:
      - uses: actions/checkout@v4

      - name: Find Python (python.exe or py.exe)
        run: |
          $py = $null

          # 1) In PATH?
          $cmd = Get-Command python.exe -ErrorAction SilentlyContinue
          if ($cmd) { $py = $cmd.Source }

          # 2) Python Launcher?
          if (-not $py) {
            $cmd2 = Get-Command py.exe -ErrorAction SilentlyContinue
            if ($cmd2) { $py = "py -3.11" }
          }

          # 3) typische Install-Pfade (falls PATH fehlt)
          if (-not $py) {
            $candidates = @(
              "C:\Python311\python.exe",
              "C:\Program Files\Python311\python.exe",
              "C:\Program Files (x86)\Python311\python.exe"
            )
            foreach ($c in $candidates) {
              if (Test-Path $c) { $py = $c; break }
            }
          }

          if (-not $py) {
            Write-Host "❌ Python not found for the runner user (service account)."
            Write-Host "➡️ Install Python for ALL users + add to MACHINE PATH, or hardcode the path."
            exit 1
          }

          "PY=$py" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "✅ Using: $py"

      - name: Python sanity check
        run: |
          if ($env:PY -like "py*") {
            py -3.11 --version
            py -3.11 -m pip --version
          } else {
            & $env:PY --version
            & $env:PY -m pip --version
          }

      - name: Create venv + install deps
        run: |
          if ($env:PY -like "py*") {
            py -3.11 -m venv .venv
          } else {
            & $env:PY -m venv .venv
          }

          .\.venv\Scripts\python -m pip install --upgrade pip
          .\.venv\Scripts\pip install -r requirements.txt
          .\.venv\Scripts\python -m playwright install chromium

      - name: Generate sitemap
        run: |
          .\.venv\Scripts\python generate_sitemap.py

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add sitemap.xml last_count.txt design_ids.txt urls.txt 2>$null

          git diff --cached --quiet
          if ($LASTEXITCODE -eq 0) {
            Write-Host "No changes to commit."
            exit 0
          }

          git commit -m "Update sitemap"
          git push
